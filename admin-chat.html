<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Chat - Equity Hubs</title>
  <style>
    /* Existing styles remain unchanged */
body {
  background: #0c1018;
  color: #fff;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  display: flex;
  overflow: hidden;
}

.container { display: flex; width: 100%; }

.sidebar {
  width: 250px;
  background: #111827;
  padding: 20px;
  overflow-y: auto;
}

.sidebar h2 { margin-bottom: 15px; }

.sidebar ul { list-style: none; padding: 0; margin: 0; }

.sidebar ul li {
  padding: 12px 10px;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.3s;
}

.sidebar ul li:hover, .sidebar ul li.active {
  background: #00ffff;
  color: #000;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #1e293b;
  border-left: 1px solid #00ffff33;
}

.messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.message {
  margin-bottom: 15px;
  padding: 10px 15px;
  border-radius: 12px;
  max-width: 70%;
  word-wrap: break-word;
}

.message.self { background: #00ffff; color: #000; margin-left: auto; text-align: right; }

.message.other { background: #111827; color: #fff; margin-right: auto; }

.input-area {
  display: flex;
  border-top: 1px solid #00ffff33;
  padding: 10px;
  background: #0c1018;
}

.input-area input {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #00ffff44;
  background: #1e293b;
  color: #fff;
  font-size: 16px;
}

.input-area button {
  padding: 10px 20px;
  margin-left: 10px;
  background: #00ffff;
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}

.input-area button:hover { background: #00e5e5; }

.error { color: #ff6b6b; padding: 10px; background: #1a0000; border-radius: 8px; margin: 10px; }

/* New media query for mobile view */
@media (max-width: 768px) {
  .messages {
    padding: 10px; /* Reduce padding to bring messages closer to input */
    margin-bottom: 0; /* Remove any default margin */
  }

  .input-area {
    padding: 5px; /* Reduce padding to minimize space above input */
  }

  .input-area input {
    padding: 8px; /* Slightly reduce input padding for mobile */
    font-size: 14px; /* Adjust font size for smaller screens */
  }

  .input-area button {
    padding: 8px 15px; /* Adjust button padding for mobile */
    font-size: 14px; /* Adjust font size for smaller screens */
  }

  /* Optional: Adjust sidebar behavior for mobile */
  .sidebar {
    width: 200px; /* Slightly reduce sidebar width on mobile */
    padding: 15px; /* Reduce sidebar padding */
  }
}
</style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Users</h2>
      <div id="errorDiv" class="error" style="display: none;"></div>
      <ul id="userList"></ul>
    </div>
    <div class="chat-area">
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, query, orderBy, onSnapshot,
    getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDnEbph9IMZuJ3REbfTsocV-g7APCrE-1w",
    authDomain: "investment-40343.firebaseapp.com",
    projectId: "investment-40343",
    storageBucket: "investment-40343.firebasestorage.app",
    messagingSenderId: "126093031981",
    appId: "1:126093031981:web:fd4ae73c063044693b16a4",
    measurementId: "G-SXL6ZGL49W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const messagesDiv = document.getElementById("messages");
  const sendBtn = document.getElementById("sendBtn");
  const messageInput = document.getElementById("messageInput");
  const userList = document.getElementById("userList");
  const errorDiv = document.getElementById("errorDiv");

  let currentUser = null;
  let selectedUserId = null;
  let unsubscribeMessages = null;

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
  }

  // ðŸ”¹ Only check if user is logged in (not admin)
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // not logged in, go back to admin login
      window.location.href = "admin.html";
      return;
    }
    currentUser = user;
    console.log("âœ… Logged in as admin:", user.email);
    loadUsers(); // always allow access
  });

  // ðŸ”¹ Load all users
  async function loadUsers() {
    try {
      const querySnap = await getDocs(collection(db, "users"));
      userList.innerHTML = "";

      if (querySnap.empty) {
        const li = document.createElement("li");
        li.textContent = "No users found";
        li.style.color = "#666";
        userList.appendChild(li);
        return;
      }

      querySnap.forEach((docSnap) => {
        const userData = docSnap.data();
        const li = document.createElement("li");
        li.textContent = userData.name || userData.email || docSnap.id;
        li.onclick = () => selectUser(docSnap.id, li);
        userList.appendChild(li);
      });
    } catch (error) {
      console.error("Error loading users:", error);
      showError("Failed to load users: " + error.message);
    }
  }

  // ðŸ”¹ Select user for chat
  function selectUser(uid, element) {
    selectedUserId = uid;
    document.querySelectorAll(".sidebar ul li").forEach(li => li.classList.remove("active"));
    element.classList.add("active");
    loadMessages(uid);
  }

  // ðŸ”¹ Load messages
  function loadMessages(uid) {
    if (unsubscribeMessages) unsubscribeMessages();

    const messagesRef = collection(db, "user_chats", uid, "messages");
    const q = query(messagesRef, orderBy("timestamp", "asc"));

    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(msg.sender === "admin" ? "self" : "other");
        div.textContent = msg.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // ðŸ”¹ Send message
  sendBtn.addEventListener("click", async () => {
    if (!selectedUserId) {
      alert("Select a user first.");
      return;
    }
    const text = messageInput.value.trim();
    if (!text) return;

    try {
      await addDoc(collection(db, "user_chats", selectedUserId, "messages"), {
        text,
        sender: "admin",
        timestamp: serverTimestamp(),
      });
      messageInput.value = "";
    } catch (error) {
      console.error("Error sending message:", error);
      showError("Failed to send message: " + error.message);
    }
  });

  // Allow Enter key to send
  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter" && selectedUserId) sendBtn.click();
  });
</script>
</body>
</html>
