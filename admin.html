<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="admin_title">Admin Dashboard - Equity Hubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <script src="https://unpkg.com/i18next@21.6.14/dist/umd/i18next.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
        body{background:#0c1018;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow-x:hidden;}
        .container{display:flex;width:100%;max-width:1200px;height:95vh;background:#1e293b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,255,.1);margin:10px 0;position:relative;}
        .sidebar{width:250px;background:#111827;padding:20px;display:flex;flex-direction:column;transition:transform .3s;}
        .sidebar nav ul{list-style:none;}
        .sidebar nav ul li{padding:15px 10px;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:background .3s;}
        .sidebar nav ul li.active a,.sidebar nav ul li:hover a{background:#00ffff;padding:18px;border-radius:15px;color:#000;text-decoration:none;}
        .sidebar nav ul li a{display:flex;align-items:center;color:inherit;text-decoration:none;width:100%;}
        .sidebar nav ul li .icon{margin-right:10px;font-size:18px;}
        .main-content{flex-grow:1;padding:30px 40px;overflow-y:auto;}
        .hamburger{display:none;position:absolute;top:20px;left:20px;background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;z-index:1000;}
        .section{background:#0c1018;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:inset 0 0 20px rgba(0,255,255,.05);}
        .section h2{color:#00ffff;margin-bottom:15px;}
        table{width:100%;border-collapse:collapse;background:#111827;border-radius:8px;overflow:hidden;}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #2d3748;}
        th{background:#1e293b;color:#00ffff;font-weight:600;}
        .language-selector select{padding:8px;border-radius:4px;background:#1e293b;color:#fff;border:1px solid #2d3748;}
        input[type=number] {background:transparent;border:none;color:#fff;width:100%;text-align:left;font-size:inherit;}
        input[type=number]:focus {outline:2px solid #00ffff;}
        @media (max-width:768px){
            .container{flex-direction:column;height:auto;}
            .sidebar{position:fixed;top:0;left:0;height:100%;transform:translateX(-100%);z-index:999;}
            .sidebar.show{transform:translateX(0);}
            .hamburger{display:block;}
            .main-content{padding:20px;}
        }
    </style>
</head>
<body>

<div class="container" id="container" style="display:none;">
    <button class="hamburger" aria-label="Toggle Sidebar"><i class="fa-solid fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <li class="active"><a href="admin.html"><i class="fa-solid fa-user-shield icon"></i><span data-i18n="admin_dashboard">Admin Dashboard</span></a></li>
                <li class="active"><a href="admin-ykc.html"><i class="fa-solid fa-id-card icon"></i><span data-i18n="admin-ykc">Admin KYC</span></a></li>
                <li><a href="deposit-requests.html"><i class="fa-solid fa-download icon"></i><span data-i18n="deposit_requests">Deposit Requests</span></a></li>
                <li><a href="withdraw-requests.html"><i class="fa-solid fa-upload icon"></i><span data-i18n="withdraw_requests">Withdraw Requests</span></a></li>
                <li><a href="accounts.html"><i class="fa-solid fa-university icon"></i><span data-i18n="edit_bank">Edit Bank</span></a></li>
                <li><a href="#" id="logout-link"><i class="fa-solid fa-right-from-bracket icon"></i><span data-i18n="logout">Logout</span></a></li>
            </ul>
        </nav>
        <div class="language-selector">
            <select id="languageSwitcher">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="es">Español</option>
            </select>
        </div>
    </div>

    <main class="main-content">
        <h1 class="welcome" data-i18n="welcome_admin">Welcome, Admin!</h1>

        <!-- User Management -->
        <section class="section">
            <h2 data-i18n="user_management">User Management</h2>
            <table id="user-table">
                <thead>
                    <tr>
                        <th data-i18n="name">Name</th>
                        <th data-i18n="email">Email</th>
                        <th data-i18n="total_deposit">Deposit</th>
                        <th data-i18n="total_profit">Profit</th>
                        <th data-i18n="total_bonus">Bonus</th>
                        <th data-i18n="withdrawals">Withdraw</th>
                        <th data-i18n="balance">Balance</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
</div>

<script type="module">
   import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    const firebaseConfig = {
        apiKey: "AIzaSyDnEbph9IMZuJ3REbfTsocV-g7APCrE-1w",
        authDomain: "investment-40343.firebaseapp.com",
        projectId: "investment-40343",
        storageBucket: "investment-40343.firebasestorage.app",
        messagingSenderId: "126093031981",
        appId: "1:126093031981:web:fd4ae73c063044693b16a4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const translations = {
        en: {
            admin_title: "Admin Dashboard",
            admin_dashboard: "Admin Dashboard",
            deposit_requests: "Deposit Requests",
            withdraw_requests: "Withdraw Requests",
            edit_bank: "Edit Bank",
            logout: "Logout",
            welcome_admin: "Welcome, Admin!",
            user_management: "User Management",
            name: "Name", email: "Email", total_deposit: "Deposit", total_profit: "Profit",
            total_bonus: "Bonus", withdrawals: "Withdraw", balance: "Balance",
            no_data: "No users found"
        }
    };

    i18next.init({ lng: 'en', resources: { en: { translation: translations.en } } }, updateContent);
    function updateContent() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.textContent = i18next.t(key);
        });
    }
    document.getElementById('languageSwitcher')?.addEventListener('change', e => i18next.changeLanguage(e.target.value, updateContent));

    // Sidebar
    document.querySelector('.hamburger').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('show'));
    document.addEventListener('click', e => {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) sidebar.classList.remove('show');
    });

    // AUTO-MAKE USER ADMIN ON VISIT
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            location.href = 'admin_login.html';
            return;
        }

        // ANYONE who visits this page becomes admin
        await setDoc(doc(db, 'admins', user.uid), {
            isAdmin: true,
            email: user.email,
            autoPromoted: true,
            promotedAt: new Date().toISOString()
        }, { merge: true });

        // Show dashboard
        document.getElementById('container').style.display = 'flex';
        loadUsers();
    });

    // -------------------------------------------------
    //  USER LIST + EDITABLE FIELDS
    // -------------------------------------------------
    async function loadUsers() {
        onSnapshot(collection(db, 'users'), snap => {
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = snap.empty ? `<tr><td colspan="7">${i18next.t('no_data')}</td></tr>` : '';

            snap.forEach(d => {
                const uid = d.id;
                const u = d.data();

                const balance = (u.totalDeposit||0) + (u.totalProfit||0) + (u.totalBonus||0) - (u.withdrawals||0);

                const tr = document.createElement('tr');
                tr.dataset.uid = uid;               // keep uid for updates

                tr.innerHTML = `
                    <td>${u.displayName || 'N/A'}</td>
                    <td>${u.email || 'N/A'}</td>
                    <td><input type="number" step="0.01" value="${(u.totalDeposit||0).toFixed(2)}" data-field="totalDeposit"></td>
                    <td><input type="number" step="0.01" value="${(u.totalProfit||0).toFixed(2)}" data-field="totalProfit"></td>
                    <td><input type="number" step="0.01" value="${(u.totalBonus||0).toFixed(2)}" data-field="totalBonus"></td>
                    <td><input type="number" step="0.01" value="${(u.withdrawals||0).toFixed(2)}" data-field="withdrawals"></td>
                    <td class="balance-cell">$${balance.toFixed(2)}</td>
                `;

                tbody.appendChild(tr);

                // ---- attach listeners to every input ----
                tr.querySelectorAll('input[data-field]').forEach(inp => {
                    const field = inp.dataset.field;

                    const commit = async () => {
                        const raw = parseFloat(inp.value);
                        const val = isNaN(raw) ? 0 : raw;

                        try {
                            await updateDoc(doc(db, 'users', uid), { [field]: val });
                            // balance will be recalculated automatically by the snapshot
                        } catch (e) {
                            console.error('Update failed', e);
                            inp.value = (u[field] || 0).toFixed(2); // revert
                        }
                    };

                    inp.addEventListener('blur', commit);
                    inp.addEventListener('keydown', e => { if (e.key === 'Enter') commit(); });
                });
            });

            // ---- recalc balance whenever any field changes (live) ----
            const recalcAllBalances = () => {
                document.querySelectorAll('#user-table tr[data-uid]').forEach(row => {
                    const cells = row.querySelectorAll('input[data-field]');
                    const deposit = parseFloat(cells[0].value) || 0;
                    const profit  = parseFloat(cells[1].value) || 0;
                    const bonus   = parseFloat(cells[2].value) || 0;
                    const withdraw= parseFloat(cells[3].value) || 0;
                    const bal = deposit + profit + bonus - withdraw;
                    row.querySelector('.balance-cell').textContent = `$${bal.toFixed(2)}`;
                });
            };
            document.querySelectorAll('input[data-field]').forEach(i => i.addEventListener('input', recalcAllBalances));
        });
    }

    // Logout
    document.getElementById('logout-link').onclick = e => {
        e.preventDefault();
        signOut(auth).then(() => location.href = 'admin_login.html');
    };
</script>
</body>
</html>